<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuizService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">backend</a> &gt; <a href="index.source.html" class="el_package">ntnu.fullstacksuperteam.backend.service</a> &gt; <span class="el_source">QuizService.java</span></div><h1>QuizService.java</h1><pre class="source lang-java linenums">package ntnu.fullstacksuperteam.backend.service;

import ntnu.fullstacksuperteam.backend.dto.QuestionDTO;
import ntnu.fullstacksuperteam.backend.dto.QuizDTO;
import ntnu.fullstacksuperteam.backend.model.*;
import ntnu.fullstacksuperteam.backend.repository.QuizRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

import java.util.ArrayList;
import java.util.List;

@Service
<span class="fc" id="L18">public class QuizService {</span>
    @Autowired
    private QuizRepository quizRepository;

    @Autowired
    private ScoresService scoresService;

    @Autowired
    private UserService userService;

    @Autowired
    private QuestionService questionService;

<span class="fc" id="L31">    private final Logger logger = LoggerFactory.getLogger(QuizService.class);</span>

    public List&lt;Quiz&gt; getAllQuizzes() {
<span class="fc" id="L34">        return quizRepository.findAll();</span>
    }

    public List&lt;Quiz&gt; searchQuizzes(String query) {
<span class="fc" id="L38">        return quizRepository.findAllByTitleContaining(query);</span>
    }

    public List&lt;Quiz&gt; getMyQuizzes(long id) {
<span class="fc" id="L42">        User user = userService.getUserById(id);</span>
<span class="fc" id="L43">        return quizRepository.findAllByAuthor(user);</span>
    }

    public Quiz getQuizById(long id) {
<span class="fc" id="L47">        Quiz quiz = quizRepository.findById(id).orElse(null);</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">        if (quiz == null) {</span>
<span class="fc" id="L49">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Quiz not found&quot;);</span>
        }
<span class="fc" id="L51">        return quiz;</span>
    }

    public Quiz getQuizPlayVersionById(long id) {
<span class="nc" id="L55">        Quiz quiz = quizRepository.findById(id).orElse(null);</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (quiz == null) {</span>
<span class="nc" id="L57">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Quiz not found&quot;);</span>
        }
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (!quiz.getRandomize()) {</span>
<span class="nc" id="L60">            return quiz;</span>
        }
<span class="nc" id="L62">        logger.info(&quot;Randomizing quiz questions and answers&quot;);</span>
<span class="nc" id="L63">        List&lt;Question&gt; questions = quiz.getQuestions();</span>
        // Randomize question answers order if question type is multiple choice
<span class="nc bnc" id="L65" title="All 2 branches missed.">        for (Question question : questions) {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            if (question instanceof TextQuestion textQuestion) {</span>
<span class="nc" id="L67">                List&lt;TextAnswer&gt; randomizedAnswers = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                while (!textQuestion.getAnswers().isEmpty()) {</span>
<span class="nc" id="L69">                    int randomIndex = (int) (Math.random() * textQuestion.getAnswers().size());</span>
<span class="nc" id="L70">                    randomizedAnswers.add(textQuestion.getAnswers().get(randomIndex));</span>
<span class="nc" id="L71">                    textQuestion.getAnswers().remove(randomIndex);</span>
<span class="nc" id="L72">                }</span>
<span class="nc" id="L73">                textQuestion.setAnswers(randomizedAnswers);</span>
            }
<span class="nc" id="L75">        }</span>

<span class="nc" id="L77">        List&lt;Question&gt; randomizedQuestions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        while (!questions.isEmpty()) {</span>
<span class="nc" id="L79">            int randomIndex = (int) (Math.random() * questions.size());</span>
<span class="nc" id="L80">            randomizedQuestions.add(questions.get(randomIndex));</span>
<span class="nc" id="L81">            questions.remove(randomIndex);</span>
<span class="nc" id="L82">        }</span>
<span class="nc" id="L83">        quiz.setQuestions(randomizedQuestions);</span>

<span class="nc" id="L85">        return quiz;</span>
    }

    public Quiz createQuiz(long userId, QuizDTO quizDTO) {
<span class="fc" id="L89">        User author = userService.getUserById(userId);</span>
<span class="fc" id="L90">        Quiz quiz = new Quiz();</span>
<span class="fc" id="L91">        quiz.setAuthor(author);</span>
<span class="fc" id="L92">        quiz.setTitle(quizDTO.getTitle());</span>
<span class="fc" id="L93">        quiz.setCategory(quizDTO.getCategory());</span>
<span class="fc" id="L94">        quiz.setDifficultyLevel(quizDTO.getDifficultyLevel());</span>
<span class="fc" id="L95">        quiz.setDescription(quizDTO.getDescription());</span>
<span class="fc" id="L96">        quiz.setRandomize(quizDTO.getRandomize());</span>

<span class="fc" id="L98">        Quiz savedQuiz = quizRepository.save(quiz);</span>

<span class="fc" id="L100">        List&lt;Question&gt; questions = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        for (QuestionDTO questionDTO : quizDTO.getQuestions()) {</span>
<span class="nc" id="L102">            questions.add(this.questionService.createQuestion(savedQuiz.getId(), questionDTO));</span>
<span class="nc" id="L103">        }</span>
<span class="fc" id="L104">        savedQuiz.setQuestions(questions);</span>

<span class="fc" id="L106">        return savedQuiz;</span>
    }

    public Quiz updateQuiz(long userId, long quizId, QuizDTO quizDTO) {
<span class="fc" id="L110">        Quiz quiz = quizRepository.findById(quizId).orElse(null);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">        if (quiz == null) {</span>
<span class="fc" id="L112">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Quiz not found&quot;);</span>
        }
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        if (quiz.getAuthor().getId() != userId) {</span>
<span class="nc" id="L115">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;You are not the author of this quiz&quot;);</span>
        }

<span class="fc" id="L118">        quiz.setTitle(quizDTO.getTitle());</span>
<span class="fc" id="L119">        quiz.setCategory(quizDTO.getCategory());</span>
<span class="fc" id="L120">        quiz.setDifficultyLevel(quizDTO.getDifficultyLevel());</span>
<span class="fc" id="L121">        quiz.setDescription(quizDTO.getDescription());</span>
<span class="fc" id="L122">        quiz.setRandomize(quizDTO.getRandomize());</span>

<span class="fc" id="L124">        List&lt;Question&gt; updatedQuestions = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        for (QuestionDTO questionDTO : quizDTO.getQuestions()) {</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">            if (questionDTO.getId() &gt; 0) {</span>
                // Update existing question
<span class="nc" id="L128">                Question updatedQuestion = questionService.updateQuestion(questionDTO);</span>
<span class="nc" id="L129">                updatedQuestions.add(updatedQuestion);</span>
<span class="nc" id="L130">                continue;</span>
            }
<span class="nc" id="L132">            Question updatedOrNewQuestion = questionService.createQuestion(quizId, questionDTO);</span>
<span class="nc" id="L133">            updatedQuestions.add(updatedOrNewQuestion);</span>
<span class="nc" id="L134">        }</span>

<span class="pc bnc" id="L136" title="All 2 branches missed.">        quiz.getQuestions().removeIf(question -&gt; !updatedQuestions.contains(question));</span>

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        for (Question question : updatedQuestions) {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (!quiz.getQuestions().contains(question)) {</span>
<span class="nc" id="L140">                quiz.getQuestions().add(question);</span>
            }
<span class="nc" id="L142">        }</span>

<span class="fc" id="L144">        return quizRepository.save(quiz);</span>
    }

    public void deleteQuiz(long userId, long quizId) {
<span class="fc" id="L148">        Quiz quiz = quizRepository.findById(quizId).orElse(null);</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">        if (quiz == null) {</span>
<span class="nc" id="L150">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Quiz not found&quot;);</span>
        }
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (quiz.getAuthor().getId() != userId) {</span>
<span class="nc" id="L153">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;You are not the author of this quiz&quot;);</span>
        }
<span class="fc" id="L155">        quizRepository.delete(quiz);</span>
<span class="fc" id="L156">    }</span>

    public List&lt;Quiz&gt; getRecentlyPlayedQuizzes(long userId) {
<span class="fc" id="L159">        User user = userService.getUserById(userId);</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L161">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;User not found&quot;);</span>
        }
<span class="fc" id="L163">        List&lt;Score&gt; scores = scoresService.getScoresByUserId(userId);</span>
<span class="fc" id="L164">        List&lt;Score&gt; recentScores = scores.subList(0, Math.min(scores.size(), 3));</span>
<span class="fc" id="L165">        List&lt;Quiz&gt; quizzes = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">        for (Score score : recentScores) {</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">            if (!quizzes.contains(score.getQuiz())) {</span>
<span class="fc" id="L168">                quizzes.add(score.getQuiz());</span>
            }
<span class="fc" id="L170">        }</span>
<span class="fc" id="L171">        return quizzes;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>